/* eslint-disable no-undef */
// Generated by fcm-worker script
importScripts(
  'https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js',
);
importScripts(
  'https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js',
);

console.log('[SW] Firebase messaging service worker starting...');

firebase.initializeApp({
  "apiKey": "AIzaSyANUdxcxppINSZkayH4nGn4t-lOTg3B7N4",
  "authDomain": "my-landing-page-e7c7e.firebaseapp.com",
  "projectId": "my-landing-page-e7c7e",
  "storageBucket": "my-landing-page-e7c7e.firebasestorage.app",
  "messagingSenderId": "999813447171",
  "appId": "1:999813447171:web:4d47bb99b3fa66909a9836",
  "measurementId": "G-43J14KHN0W"
});

console.log('[SW] Firebase initialized');

const messaging = firebase.messaging();

console.log('[SW] Messaging instance created');

messaging.onBackgroundMessage(function (payload) {
  console.log(
    '[SW] Received background message:',
    payload,
  );
  
  const notificationTitle = payload.notification?.title || 'New Message';
  const notificationOptions = {
    body: payload.notification?.body || 'You have a new message',
    icon: '/firebase-logo.png',
    badge: '/firebase-logo.png',
    tag: 'fcm-notification',
    data: payload.data || {},
  };

  console.log('[SW] Showing notification:', notificationTitle, notificationOptions);

  // Hiển thị notification
  self.registration.showNotification(notificationTitle, notificationOptions);

  // Gửi message qua BroadcastChannel
  if ('BroadcastChannel' in self) {
    const channel = new BroadcastChannel('fcm-notifications');
    channel.postMessage({
      type: 'FCM_BACKGROUND_NOTIFICATION',
      payload: {
        from: payload.from,
        messageId: payload.messageId,
        notification: payload.notification,
        collapseKey: payload.collapseKey,
      }
    });
    console.log('[SW] Message sent via BroadcastChannel');
  } else {
    // Fallback: sử dụng postMessage
    self.clients.matchAll().then((clients) => {
      clients.forEach((client) => {
        client.postMessage({
          type: 'FCM_BACKGROUND_NOTIFICATION',
          payload: {
            from: payload.from,
            messageId: payload.messageId,
            notification: payload.notification,
            collapseKey: payload.collapseKey,
          }
        });
      });
    });
    console.log('[SW] Message sent via postMessage');
  }
});

console.log('[SW] Background message handler registered');
